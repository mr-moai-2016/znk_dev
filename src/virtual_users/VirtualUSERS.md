# Moai/VirtulUSERS
-----------------------------------
  このドキュメントはMoaiの旧バージョン Moai Ver1.1.8 にあったものです.
  Moaiの最新版Moai Ver2.0がリリースされたため、既にこの内容は古いものとなっている可能性がありますがしばらく残します.

## <a name="index"></a>目次
-----------------------------------
* [MoaiのVirtulUSERS機能の目的](#user-content-pos1)
* [この機能を使うにはどうすればよいか？](#user-content-pos2)
* [Web閲覧時に送信される情報とは何なのか？](#user-content-pos3)
* [ランダマイズの候補として使用するtxtファイルについて](#user-content-txt_for_randomize)
* [ふたばにて手動で偽装を行う場合(参考)](#user-content-futaba_note)

## <a name="pos1"></a>MoaiのVirtulUSERS機能の目的
-----------------------------------

  VirtulUSERSとはVirtual User-agent Screen-size and Everything Randomize Systemの略である.
  この記事ではVirtulUSERSの目的について詳しく述べる.

  ネット上のサイトはあらゆる側面からあなたのマシン固有の情報を集め、あなた個人を識別しようと試みる.  

  VirtulUSERS機能はIPを除くすべてのあなたのマシンの情報をランダムに仮想化する.
  これはブラウザと送信先のサイトとの通信を仲介し、IPを除くそれら全ての情報に関して、
  あなたの実際のマシンおよびブラウザ環境とは異なる架空かつランダムな環境へ見せかけた上でサイトと通信することで実現する. 
  これにより送信先はあなたを正しく識別できなくなる.  
  つまり早い話、これはよくあるあなたのプライベートを守るセキュリティー機能の一つである.  

  これが機能するのはMoaiが起動している間である.
  この間、あなたのマシン本来の姿がIPを除いて完全に隠蔽される.
  これによりブラウザのCookieやJavascriptを無効にしたまま掲示板などを閲覧することは勿論、
  レスやスレ立てをすることすら可能となり、非常にセキュアだ.  

  これにルーカチ(ルータリセット)などによりIPを変える操作を加えることで、
  掲示板などにおいて完全に別のユーザに生まれ変わるという効果もあろう.

> 現在デフォルトで仮想環境の構築をサポートしているサイトはふたばと５ちゃんねるのみである.
> その他のサイトも当然閲覧やレス投稿など普通に可能だが、仮想環境の構築まで行うには、
> そのサイト向けのfilterやpluginを作成して追加しなければならない.

  また、場合によってはブラウザのCookieやJavascriptを無効にした状態でも掲示板にレス出来るという
  ほとんどの方にとって極めてどうでもよい副次的効果もある.  

  また **parent_proxy.txt** に使用したいプロキシの候補を複数列挙しておくことで、
  Moai Web上でこれらのプロキシがメニュー表示され、現在使用するプロキシを簡単かつ
  瞬時に切り替えができる.  

  <a href="#user-content-index">目次へ戻る</a>


## <a name="pos2"></a>この機能を使うにはどうすればよいか？
-----------------------------------

  これはMoaiが提供するVirtulUSERSボタンを押すだけで全て自動的に行われる.
  この方法については<a href="https://mr-moai-2016.github.io/moai1.1/local_proxy.html#FirstLocalProxy">こちら</a>を参照していただきたい.

  <a href="#user-content-index">目次へ戻る</a>


## <a name="pos3"></a>Web閲覧時に送信される情報とは何なのか？
-----------------------------------

  以下の概念図を見てみよう.  

~~~
                          HTTPヘッダ
  あなたのブラウザ環境 === POST変数     ===> 送信先のサイト
                          クッキー
~~~

  これは一般に送信先サイトへ実際に何が送信されるかを示したものである.  
  送信先のサイトへはあなたのマシン固有の様々な情報が送信されるのであるが、
  それらはIPを除けばダイレクトに送信されるわけではなく、すべて上記にある３つの
  うちのいずれかの範疇にまずパックされて送信されるということだ.  
  (厳密に言えばクッキーも最終的にHTTPヘッダの範疇になるが、ここでは別枠とした)  

  例えばふたばちゃんねるはこの種の話の非常に良い教材となる.
  閲覧時およびレス投稿時に送信されるあなたのマシン情報の概要を以下で説明しよう.

~~~
  1. IP  
    通常、プロバイダが割り当てたあなたの動的なIPアドレスである.  
    その場合、ルーカチ(以下、ルータのリセットの意味でこの言葉を使う)でこの値を
    変更可能である. その他、外部プロキシ、VPNを用いた場合はそのIPとなる.  

  2. User-Agent  
    簡単に言えば、あなたの使っているブラウザの識別名である.  
    この値はHTTPヘッダに格納された形で送信される.  

  3. posttimeおよびそれに類したふたばより発行される値  
    この値はふたばに初アクセスした時間(およびそれに類した値)である. 現状では
    カタログに初めてアクセスするか、または初めてレス投稿した際に設定されるようである.
    あるいは /bin/cachemt7.php にアクセスしたときにそれに類した値が生成される形となる.
    一旦設定されると、CookieおよびブラウザキャッシュおよびlocalStorage これら全てを
    消去しない限り同じ値が残り続ける. この値はPOST変数 pthb, pthc, (pthd) とCookieの
    posttime値として送信される.  

  4. SCreenSiZe  
    簡単に言えば、あなたの使っているモニタの解像度と色深度の情報である.
    (Javascriptにこれを取得するAPIがあり、これを利用しているようである)
    この値はPOST変数 scsz として送信される.  

  5. Fingerprint  
    この値はあなたのマシン環境の様々な情報を集めて文字列とし、それを元に32bit整数の
    ハッシュ値を計算したものである.この値はPOST変数 flrv, flvv として送信される.

    ハッシュ値が何のことかわからない方は、次のように考えればよい.
    例えばあなたのマシンの特徴を示す情報が３つあったとしてそれをそれぞれ仮に
    数字の 2, 4, 7 とする. これらを足し算して合計すると 2 + 4 + 7 = 13 となるが、
    この 13 がハッシュ値に相当しここではこれが送信される. 非常に大雑把だが、
    とりあえずそのようなイメージで十分である.

    ここでのポイントは 13 から元の値 2, 4, 7 を一意には復元できないということである.
    よってこの値は実のところデタラメに設定しても一般にその妥当性を検証する術はない.  
~~~

  お分かり戴けただろうか？  
  繰り返しになるが、上記はIPを除けば最終的にはHTTPヘッダ、POST変数、そしてCookieの値の
  いずれかとして送信される. そしてあなたがもし、そのとき送信されるこれらHTTPヘッダや
  POST変数やCookieを直接修正する術を持つなら、上記の値はすべて(ブラウザやモニタの解像度
  などのマシン環境を実際に変更することなく)自由に仮想環境を構築可能であるということだ.

  では具体的にどうやって仮想環境を構築するのか？
  実のところこれは手動でも可能であるし、プログラミングするにしてもそう難しい話でもないが
  MoaiのVirtulUSERS機能はそれをボタン一発ですべて自動で行い、楽ができるというものである.

  <a href="#user-content-index">目次へ戻る</a>


## <a name="txt_for_randomize"></a>ランダマイズの候補として使用するtxtファイルについて
-----------------------------------

#### user_agent.txt
このファイルはMoai Ver1.1.8以前にのみ存在する.
Moai Ver2.0では次世代の仮想化エンジンcustom_boyを導入したため、このファイルは廃止された.

このファイルはRandomizeの際に選択されるUser-Agentの候補を列挙したものである.
(一行につき一つ記述する)
これらのUser-Agentはネット上に転がっているものを適当に巡回してコピペしただけのものであり、
候補のパターンはあなたのお好みで自由に変えてよい.
これを修正することなくそのまま使ってもよいが、新しいブラウザが登場するたびに段々とその情報は古くなるし、
できればあなた独自のプライベートな user_agent.txtを生成しておくほうが望ましい.
手動で好みのリストを作成していってもよいし、 巷にあるUser-Agentジェネレータを使うのも一つの手である.
このファイルにおいて、空行および # 記号で始まる行は候補値とはならず無視される.

#### screen_size.txt
このファイルはMoai Ver1.1.8以前にのみ存在する.
Moai Ver2.0では次世代の仮想化エンジンcustom_boyを導入したため、このファイルは廃止された.

このファイルはRandomizeの際に選択されるscszの解像度の候補を各行で列挙したものである.
このファイルにおいて、空行および # 記号で始まる行は候補値とはならず無視される.
このファイルは現状ではfutabaプラグインにおいてのみ使われる.

#### parent_proxy.txt
このファイルは Web Configuration画面上の parent_proxy メニューとして表示される
外部プロキシの候補を列挙したものである (一行につき一つ記述する).
必ず「ホスト名:ポート番号」という形式で記述すること.
これらのプロキシは我々が開発している時点において、ネット上に転がっているものを
適当に巡回してコピペしただけのものである.
この記事をあなたが読んでいるころにはそれらは既に無効となっている可能性が高い.
よって候補のパターンは必要であればあなたが適宜変更、追加、削除していただきたい.
このファイルにおいて、空行および # 記号で始まる行は候補値とはならず無視される.

  <a href="#user-content-index">目次へ戻る</a>


## <a name="futaba_note"></a>ふたばにて手動で偽装を行う場合(参考)
-----------------------------------

  参考のため、MoaiのVirtul USERSのような機能を使わず、手動で偽装する方法も記載しておいた.
  これはふたばの例であるが、このような偽装を全て漏れなく手動でやろうとした場合、
  以下のようにかなりの手間となる.

~~~
  1. ブラウザで開いているふたば関係のタブを一旦閉じる.
     これによりうっかりPOST変数などが残留してしまう可能性を排除する.
     キャッシュを消してもこれが消えずに残る場合もあるため一旦閉じた方が確実だろう.

  2. ルーカチする.

  3. ブラウザのクッキー、キャッシュ、localStorageを消去.
     localStorageの消去についてはブラウザ毎に異なるが、Firefoxの場合
     「オフラインWebページとユーザデータ」とある部分で「今すぐ消去」ボタンを押す.

  4. User-Agentの値を変更する. 
     最も安直な方法は、使うブラウザを変更することである.
     あるいは使ってるブラウザにUser-Agent偽装アドオンなどが存在するならそれを入れて
     別の値に設定する.

  5. 新しいタブを開いた上で1で閉じたふたば関係のページなどに再度アクセスする.
     逆に言えばこの段階になるまでは、まだふたば関係のページを開いてはいけない.

  6. モニタの解像度や色深度を変更する.
     最も安直な方法は、モニタのプロパティより解像度と色ｓ…
     …というか、たかがふたばのためにこんなことまで実際にはやってられないので、
     ここは以下にある「POST変数を手動で修正する方法」によって、POST変数scszを直接変更する.

  7. POST変数 flrv, flvv(Fingerprint)の値を変更する. 
     flrvは以前まではUser-AgentやブラウザのPlugin構成を変更すればその値も変わっていたが、
     今現在はそれらを変更してもその値は変わらなくなった（その他どのような要素に依存しているか
     についてはfingerprint.jsを参照して欲しい).
     flvvはUser-Agentを変更しても変わらないがブラウザのPlugin構成を変更すればその値は変わる.
     いずれにせよ、以下にある「POST変数を手動で修正する方法」によって、これらのPOST変数を
     直接変更するのが妥当だろう.
     値は32bit整数なら何でもよい.
     (ついでにflrvも直接変更しておけばよかろう. ただしflvvとは異なる32bit整数値にしておく)

  8. jsの値をonに変更する. 
     最も安直な方法は、女子小学生へonして変態すｒ…
     ではなく、この値はJavaScriptを実行したかどうかを判断するためのものであり、
     /bin/base4.js を実行すると on に設定される仕組みとなっている.
     これを on にしておかないと「環境変数がありません(JavaScriptがオフ？)」という
     エラーが表示され、投稿に失敗する.
     よって以下にある「POST変数を手動で修正する方法」によって、POST変数jsの値をonに変更する.

  9. レス投稿またはスレ立て.
     「Cookieを有効にしてください」と出る場合は、もう一度投稿.
      本当にCookieを無効にしていない限りは、2回目はうまくいくはずである.
~~~

#####  ※ POST変数を手動で修正する方法
~~~html
  Step1.
    まずスレのHTMLを保存する

  Step2.
    次に保存したスレのHTMLをテキストエディタ(メモ帳など)で開き、
    その中身を直接書き換えて修正する
    <script type="text/javascript" src="/bin/base4.js?d"></script> などと書かれた部分があるはずである
    このbase4.jsが邪悪の元凶と言えよう. コイツがあなたのマシンを識別するための数々の変数の値を設定している.
    そしてこのままでは base4.js を実行してしまうので、これが実行されないよう、この部分を削除する.

  Step3.
    後は <input type=hidden…> などと書かれている部分を好き放題変えればよいのだが、
    例えばflrvならば、

       <input type=hidden id="flrv" name="flrv" value="">

    などと書かれてあるが、この部分を

       <input type=hidden id="flrv" name="flrv" value="77777777"> 

    とすれば晴れてflrvの値を77777777に偽装できる.

  後は修正したHTMLをダブルクリックして、表示される投稿フォームから投稿すれば
  上において偽装された値が送信されることだろう.
~~~

  <a href="#user-content-index">目次へ戻る</a>


